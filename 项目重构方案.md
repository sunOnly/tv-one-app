# TV-One-App 项目重构方案

根据系统设计文档，本方案旨在优化工程结构与代码逻辑，实现分层设计，提高代码质量和可维护性。

## 一、工程结构优化

### 1. 分层架构设计

将项目重构为清晰的分层架构，包括：

```
src/
├── api/                # API接口层
│   ├── user.js         # 用户相关API
│   ├── member.js       # 会员相关API
│   ├── wallet.js       # 钱包相关API
│   └── share.js        # 分享赚钱相关API
├── services/           # 业务逻辑层
│   ├── userService.js  # 用户服务
│   ├── memberService.js # 会员服务
│   ├── walletService.js # 钱包服务
│   └── shareService.js # 分享赚钱服务
├── dao/                # 数据访问层
│   ├── userDao.js      # 用户数据访问
│   ├── memberDao.js    # 会员数据访问
│   ├── walletDao.js    # 钱包数据访问
│   └── shareDao.js     # 分享数据访问
├── db/                 # 数据库层
│   ├── mysql-db.js     # MySQL数据库连接
│   └── mock-db.js      # 模拟数据
├── common/             # 公共模块
│   ├── utils.js        # 工具函数
│   ├── constants.js    # 常量定义
│   └── config.js       # 配置文件
├── components/         # UI组件
├── pages/              # 页面
└── store/              # 状态管理
```

### 2. 数据流转设计

```
页面层(Pages) → API层 → 服务层(Services) → 数据访问层(DAO) → 数据库层(DB)
```

## 二、功能模块优化

### 1. 用户注册/登录模块

#### 优化内容：

- 将登录逻辑从页面层抽离到服务层
- 实现统一的用户认证服务
- 优化邀请码注册流程，确保用户关联关系正确建立
- 完善错误处理和数据验证

#### 代码结构：

```javascript
// api/user.js
export const login = (params) => {
  return callService('userService.login', params);
};

export const register = (params) => {
  return callService('userService.register', params);
};

// services/userService.js
export const login = async (params) => {
  try {
    const result = await userDao.login(params);
    return { code: 0, data: result };
  } catch (error) {
    console.error('登录失败:', error);
    return { code: -1, msg: '登录失败，请稍后再试' };
  }
};
```

### 2. 会员系统模块

#### 优化内容：

- 实现会员等级与权益的统一管理
- 优化会员升级逻辑
- 完善会员信息展示

#### 代码结构：

```javascript
// services/memberService.js
export const getMemberInfo = async (userId) => {
  try {
    const memberInfo = await memberDao.getMemberInfo(userId);
    if (!memberInfo) {
      return { level: 0, level_name: '普通用户' };
    }
    return memberInfo;
  } catch (error) {
    console.error('获取会员信息失败:', error);
    return { level: 0, level_name: '普通用户' };
  }
};

export const upgradeMember = async (userId, levelId) => {
  // 会员升级逻辑
};
```

### 3. 钱包功能模块

#### 优化内容：

- 实现余额和返利的统一管理
- 优化返利记录查询
- 完善钱包安全机制

#### 代码结构：

```javascript
// services/walletService.js
export const getUserBalance = async (userId) => {
  try {
    const balance = await walletDao.getUserBalance(userId);
    return { code: 0, balance };
  } catch (error) {
    console.error('获取余额失败:', error);
    return { code: -1, msg: '获取余额失败' };
  }
};

export const getRebateRecords = async (userId, page, limit) => {
  // 获取返利记录逻辑
};
```

### 4. 分享赚钱系统模块

#### 优化内容：

- 优化邀请链接和二维码生成
- 完善多级返利计算逻辑
- 优化邀请统计和返利明细展示

#### 代码结构：

```javascript
// services/shareService.js
export const generateInviteCode = async (userId) => {
  // 生成邀请码逻辑
};

export const calculateRebate = async (orderId, amount) => {
  // 计算多级返利逻辑
  // 一级返利10%，二级返利5%，三级返利2%
};
```

## 三、数据库优化

### 1. 数据表结构优化

- 优化索引设计，提高查询效率
- 完善字段定义，确保数据完整性
- 添加必要的约束和关联

### 2. 数据访问层优化

- 实现统一的数据访问接口
- 优化SQL查询，提高性能
- 实现事务管理，确保数据一致性

```javascript
// dao/baseDao.js
export class BaseDao {
  constructor(tableName) {
    this.tableName = tableName;
  }
  
  async findById(id) {
    try {
      const sql = `SELECT * FROM ${this.tableName} WHERE _id = ?`;
      const result = await MySQLDB.query(sql, [id]);
      return result[0];
    } catch (error) {
      console.error(`查询${this.tableName}失败:`, error);
      return null;
    }
  }
  
  // 其他通用方法...
}
```

## 四、Mock数据机制优化

### 1. 统一的Mock数据管理

- 实现统一的Mock数据配置
- 优化Mock数据与真实数据的切换机制
- 确保Mock数据与真实数据结构一致

```javascript
// db/mock-db.js
export const mockData = {
  // 用户相关
  user: {
    login: { code: 0, token: 'mock_token', userInfo: { /* 用户信息 */ } },
    register: { code: 0, msg: '注册成功' },
    // 其他接口...
  },
  
  // 会员相关
  member: {
    getMemberInfo: { level: 1, level_name: 'VIP会员', expire_date: Date.now() + 30*24*60*60*1000 },
    // 其他接口...
  },
  
  // 钱包相关
  wallet: {
    getUserBalance: { balance: 100.00, total_rebate: 50.00 },
    // 其他接口...
  },
  
  // 分享赚钱相关
  share: {
    getInviteCode: { invite_code: 'MOCK123456' },
    // 其他接口...
  }
};
```

### 2. API响应处理优化

```javascript
// api/base.js
export const callService = async (servicePath, params) => {
  try {
    // 尝试调用真实服务
    const [serviceName, methodName] = servicePath.split('.');
    const service = require(`../services/${serviceName}`);
    return await service[methodName](params);
  } catch (error) {
    console.error(`服务调用失败: ${servicePath}`, error);
    
    // 服务调用失败，返回Mock数据
    const [serviceName, methodName] = servicePath.split('.');
    const mockResult = mockData[serviceName]?.[methodName];
    
    if (mockResult) {
      console.warn(`使用Mock数据: ${servicePath}`);
      return mockResult;
    }
    
    return { code: -1, msg: '服务调用失败' };
  }
};
```

## 五、实施步骤

1. **准备阶段**
   - 备份当前代码
   - 创建新的分支进行重构

2. **基础架构重构**
   - 创建分层目录结构
   - 实现基础的数据库连接和Mock数据机制

3. **核心模块重构**
   - 用户认证模块
   - 会员系统模块
   - 钱包功能模块
   - 分享赚钱系统模块

4. **UI层适配**
   - 调整页面代码，适配新的API和服务
   - 优化用户界面和交互

5. **测试与优化**
   - 功能测试
   - 性能测试
   - 代码优化

6. **部署上线**
   - 合并代码
   - 部署新版本
   - 监控系统运行状态

## 六、预期效果

1. **代码质量提升**
   - 清晰的分层架构
   - 高内聚低耦合的模块设计
   - 统一的编码规范

2. **功能完善**
   - 完整实现系统设计文档中的所有功能
   - 优化用户体验
   - 提高系统稳定性

3. **可维护性提升**
   - 降低代码复杂度
   - 提高代码可读性
   - 便于后续功能扩展

4. **性能优化**
   - 提高数据库访问效率
   - 优化前端渲染性能
   - 减少不必要的网络请求